---
title: Pinia源码浅析
date: 2024-04-26 17:23:07
permalink: /pages/3183ee/
categories:
  - 前端
  - Vue
tags:
  -
author:
  name: 东流
  link: https://github.com/Jinuss
---

### Pinia 源码浅析

#### 概述

`Pinia` 中只用到了 vue-demi 一种库，vue-demi 的介绍可以参考 [vue-demi](/pages/3183r7jkfee/)。

`Pinia`可以在 vue2 和 vue3 中用于数据或状态的管理，同时 pinia 还提供了极其丰富的浏览器调试插件工具

#### vue2 中使用 Pinia

`pinia`提供了`PiniaVuePlugin`，在 vue2 中需要手动注册

```js
import Vue from "vue";
import { PiniaVuePlugin, createPinia } from "pinia";

Vue.use(PiniaVuePlugin);
const pinia = createPinia();

new Vue({
  el: "#app",
  // ...
  pinia,
});
```

##### `PiniaVuePlugin` 原理

`PiniaVuePlugin`是一个函数，注册时会被作为 install 方法，接收传入的参数 Vue,然后再通过`Vue.mixin`全局混入`breforeCreate`和`destroyed`这两个生命周期钩子函数，影响到每一个 Vue 实例。

###### `breforeCreate`

在这个钩子中 将选项中的 pinia 实例挂载到 vue 上。

```js
  beforeCreate() {
   ...
    this._provided[piniaSymbol]=pinia
    this.$pinia = pinia;
    pinia._a=this //将vue挂载到pinia上，方便于pinia注册插件
   ...
  }
```

###### `destroyed`

在销毁组件时，将组件实例从 pinia 实例中移除。

#### vue3 中使用 Pinia

vue3 中使用 Pinia 需要先调用`createPinia`创建 Pinia 实例，返回 pinia 对象，再手动注册 Pinia 实例。

##### `createPinia` 创建 Pinia 实例

`createPinia`函数是`Pinia`的核心函数，它返回一个`Pinia`实例，该实例包含`install`方法，用于安装`Pinia`插件,以及`use`方法，用于注册插件，比如数据持久化插件`piniaPluginPersistedstate`

`createPinia`首先通过`vueDemi.effectScope`创建一个独立的作用域`scope`，再通过`scope.run`方法返回一个`vueDemi.ref({})` ref 对象作为`state`

由上可知 vue2 中使用`Pinia`也会调用`createPinia`方法创建实例，因此在`install`属性方法中 Pinia 判断了当前环境是否是 vue2,如果不是，则执行`app.config.globalProperties.$pinia = pinia;`将 pinia 实例挂载到 vue 实例上

```js
 export function createPinia() {
     const pinia =vueDemi.markRaw({
         install:(app)=>{/*...*/},
         use:(plugin)=>{/*...*/},
         _p,// 通过pinia.use的插件集合
         _a:null // 指向vue
         _e:scope,//独立作用域
         _s:new Map(),
         state, // 全局ref对象
     }
     return pinia
 }
```

##### `defineStore` 定义 Store

`defineStore` 定义 store，接受一个唯一的 `id`、`setup`和 配置项`setupOptions`，其中定义并返回了`useStore`函数,

如果Pinia中没有定义了同样的`id`，就判断参数`setup`是否是一个函数，如果是函数，则调用`createSetupStore`,否则调用`createOptionsStore`创建store。
如果Pinia中已经定义了同名`id`的store，否则通过`id`获取store并返回。

###### `createSetupStore`

`createSetupStore` 接收 6 个参数,分别是`id`,`setup`,`options`,`pinia`,`hot`,`isOptionsStore`

###### `createOptionsStore`

#### `storeToRefs`

`storeToRefs`接收一个参数`store`,作用是从`store`中解构出响应式数据。

pinia 内部实现`storeToRefs`的逻辑是先判断是否是 vue2，
如果是 vu2，则通过`vueDemi.toRef`工具函数将 store 转为响应式数据，然后返回；
如果当前是 vue3，则分为两步：

1.  定义一个空对象 refs,通过`vueDemi.toRaw`将 store 转为普通对象并返回
2.  循环遍历第 1 步中的对象，通过`vueDemi.isRef`和`vueDemi.isReactive`判断其值是否是响应式数据，如果是，则通过`vueDemi.toRef`将响应式数据转为普通数据，然后返回；
3.  返回 refs
