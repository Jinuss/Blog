---
title: Pinia源码浅析
date: 2024-04-26 17:23:07
permalink: /pages/3183ee/
categories:
  - 前端
  - Vue
tags:
  -
author:
  name: 东流
  link: https://github.com/Jinuss
---

### Pinia 源码浅析

#### vue-demi

`Pinia` 中只用到了 vue-demi 一种库，vue-demi 的介绍可以参考 [vue-demi](/pages/3183r7jkfee/)

#### `createPinia` 创建Pinia 实例

`createPinia`函数是`Pinia`的核心函数，它返回一个`Pinia`实例，该实例包含`install`方法，用于安装`Pinia`插件,以及`use`方法，用于注册插件，比如数据持久化插件`piniaPluginPersistedstate`

```js
 export function createPinia() {
     const pinia =vueDemi.markRaw({
         install:(app)=>{/*...*/},
         use:(plugin)=>{/*...*/},
         _p,
         _a:null
         _e:scope,
         _s:new Map(),
         state,
     }
     return pinia
 }
```

#### `defineStore` 定义 Store

`vueDemi.hasInjectionContext()` 函数用于检查当前环境是否具有注入上下文，返回的是一个布尔值

`defineStore` 定义 store，接受一个唯一的 id 字符串和 store 配置项，其中定义并返回了`useStore`函数,配置项可以是函数也可以是对象, `defineStore`内部提供了`createSetupStore`和`createOptionsStore`两种方式创建 store

##### `createSetupStore`
    
  `createSetupStore` 接收6个参数,分别是`id`,`setup`,`options`,`pinia`,`hot`,`isOptionsStore`
   

##### `createOptionsStore`

#### `storeToRefs`
  `storeToRefs`接收一个参数`store`,作用是从`store`中解构出响应式数据。

   pinia内部实现`storeToRefs`的逻辑是先判断是否是vue2，
   如果是vu2，则通过`vueDemi.toRef`工具函数将store转为响应式数据，然后返回；
   如果当前是vue3，则分为两步：
   1. 定义一个空对象refs,通过`vueDemi.toRaw`将store转为普通对象并返回
   2. 循环遍历第1步中的对象，通过`vueDemi.isRef`和`vueDemi.isReactive`判断其值是否是响应式数据，如果是，则通过`vueDemi.toRef`将响应式数据转为普通数据，然后返回；
   3. 返回refs
