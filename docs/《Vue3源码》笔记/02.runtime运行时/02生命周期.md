---
title: 生命周期
date: 2024-06-06 11:01:26
permalink: /pages/dd5d4ff5/
categories:
  - 《Vue3源码》笔记
  - runtime运行时
tags:
  -
author:
  name: 东流
  link: https://github.com/Jinuss
---

### 概述

生命周期在`Vue3`中是一个很重要的概念，它允许我们在特定的时间点执行一些代码，比如在组件创建、更新和销毁时执行一些操作。

生命周期函数分为以下几种：

- 1.`onBeforeMount`: 在组件挂载之前执行
- 2.`onMounted`: 在组件挂载之后执行
- 3.`onBeforeUpdate`: 在组件更新之前执行
- 4.`onUpdated`: 在组件更新之后执行
- 5.`onBeforeUnmount`: 在组件销毁之前执行
- 6.`onUnmounted`: 在组件销毁之后执行
- 7.`onServerPrefetch`: 在服务器端渲染时执行
- 8.`onRenderTracked`: 在组件渲染时执行
- 9.`onRenderTriggered`: 在组件渲染时执行
- 10.`onErrorCaptured`: 在组件发生错误时执行

#### 源码分析

`Vue3`中的上述这些生命周期钩子函数的实现大同小异，主要都是基于`hook`函数实现，位于`packages\runtime-core\dist\runtime-core.cjs.js`

```js
const createHook =
  (lifecycle) =>
  (hook, target = currentInstance) => {
    if (!isInSSRComponentSetup || lifecycle === "sp") {
      injectHook(lifecycle, (...args) => hook(...args), target);
    }
  };
```

`lifecycle`为`onBeforeMount`等钩子函数名称,如下枚举：,`hook`就是钩子函数中的回调函数,`target`为当前组件实例

```js
export enum LifecycleHooks {
  BEFORE_CREATE = 'bc',
  CREATED = 'c',
  BEFORE_MOUNT = 'bm',
  MOUNTED = 'm',
  BEFORE_UPDATE = 'bu',
  UPDATED = 'u',
  BEFORE_UNMOUNT = 'bum',
  UNMOUNTED = 'um',
  DEACTIVATED = 'da',
  ACTIVATED = 'a',
  RENDER_TRIGGERED = 'rtg',
  RENDER_TRACKED = 'rtc',
  ERROR_CAPTURED = 'ec',
  SERVER_PREFETCH = 'sp',
}
```

```js
function injectHook(type, hook, target = currentInstance, prepend = false) {
  if (target) {
    const hooks = target[type] || (target[type] = []);
    const wrappedHook =
      hook.__weh ||
      (hook.__weh = (...args) => {
        if (target.isUnmounted) {
          return;
        }
        reactivity.pauseTracking();
        const reset = setCurrentInstance(target);
        const res = callWithAsyncErrorHandling(hook, target, type, args);
        reset();
        reactivity.resetTracking();
        return res;
      });
    if (prepend) {
      hooks.unshift(wrappedHook);
    } else {
      hooks.push(wrappedHook);
    }
    return wrappedHook;
  }
}
```
